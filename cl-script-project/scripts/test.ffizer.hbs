#!/usr/bin/env -S sbcl --script
; -*-Lisp-*-
(cl:require :asdf)
(asdf:require-system 'uiop)

;; When building, compile all fasl files under build/interactive/IMPL
(let* ((path (uiop:pathname-parent-directory-pathname cl:*load-truename*))
       (build-relative-subdir (cl:make-pathname
                               :directory (list :relative "build" "interactive"
                                                (asdf:implementation-identifier))))
       (build-absolute-subdir (cl:merge-pathnames build-relative-subdir path))
       (output-root-dir (cl:merge-pathnames "**/*.*" build-absolute-subdir)))
  (asdf:initialize-output-translations
   ;; Use namestring here of the project path so directories inside of
   ;; build/release end up being src, cli, systems... instead of starting from
   ;; /home/...
   `(:output-translations (,(cl:namestring path) ,output-root-dir)
     :disable-cache :ignore-inherited-configuration))
  (asdf:initialize-source-registry
   `(:source-registry
     ;; Don't use dependencies from other directories
     :ignore-inherited-configuration
     (:directory ,path)
     (:tree ,(cl:merge-pathnames "peru-managed-systems/" path))
     (:tree ,(cl:merge-pathnames "systems/" path)))))

(asdf:require-system :{{ project }})
(asdf:require-system :{{ project }}/test)

(asdf:test-system '{{ project }}/test)
